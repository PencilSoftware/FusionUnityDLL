name: Build Fusion Unity Library for Headset

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    name: Build Windows x64
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Build
      run: |
        cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

    - name: Prepare artifacts
      run: |
        mkdir artifacts
        copy build\${{ env.BUILD_TYPE }}\FusionUnity.dll artifacts\
        if (Test-Path "build\${{ env.BUILD_TYPE }}\FusionUnity.pdb") { copy build\${{ env.BUILD_TYPE }}\FusionUnity.pdb artifacts\ }

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FusionUnity-Windows-x64
        path: artifacts/
        retention-days: 30

  build-android:
    name: Build Android Libraries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        android_abi: [armeabi-v7a, arm64-v8a]
        include:
          - android_abi: armeabi-v7a
            arch_name: ARMv7a-32bit
            android_platform: android-21
          - android_abi: arm64-v8a
            arch_name: ARMv8a-64bit
            android_platform: android-21

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build

    - name: Configure CMake for Android ${{ matrix.android_abi }}
      run: |
        mkdir build-${{ matrix.android_abi }}
        cd build-${{ matrix.android_abi }}
        cmake .. -G "Ninja" \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${{ matrix.android_abi }} \
          -DANDROID_PLATFORM=${{ matrix.android_platform }} \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_SHARED_LINKER_FLAGS="-Wl,-z,max-page-size=0x4000" \
          -DCMAKE_EXE_LINKER_FLAGS="-Wl,-z,max-page-size=0x4000"

    - name: Build ${{ matrix.android_abi }}
      run: |
        cmake --build build-${{ matrix.android_abi }} --parallel

    - name: Prepare artifacts for ${{ matrix.android_abi }}
      run: |
        mkdir artifacts-${{ matrix.android_abi }}
        cp build-${{ matrix.android_abi }}/libFusionUnity.so artifacts-${{ matrix.android_abi }}/

    - name: Upload Android ${{ matrix.arch_name }} artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FusionUnity-Android-${{ matrix.arch_name }}
        path: artifacts-${{ matrix.android_abi }}/
        retention-days: 30

  package-unity:
    name: Create Unity Package
    needs: [build-windows, build-android]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: FusionUnity-Windows-x64
        path: artifacts/windows/

    - name: Download Android ARMv7a artifacts
      uses: actions/download-artifact@v4
      with:
        name: FusionUnity-Android-ARMv7a-32bit
        path: artifacts/android-armv7a/

    - name: Download Android ARMv8a artifacts
      uses: actions/download-artifact@v4
      with:
        name: FusionUnity-Android-ARMv8a-64bit
        path: artifacts/android-arm64/

    - name: Create Unity package
      run: |
        mkdir -p unity-package/Assets/Plugins/FusionUnity/Windows/x86_64
        mkdir -p unity-package/Assets/Plugins/FusionUnity/Android/libs/armeabi-v7a
        mkdir -p unity-package/Assets/Plugins/FusionUnity/Android/libs/arm64-v8a
        mkdir -p unity-package/Assets/Scripts/FusionUnity
        
        # å¤åˆ¶Windows DLL
        cp artifacts/windows/FusionUnity.dll unity-package/Assets/Plugins/FusionUnity/Windows/x86_64/
        
        # å¤åˆ¶Androidåº“ - 32ä½ARMv7a (å…¼å®¹armv8A 32ä½)
        cp artifacts/android-armv7a/libFusionUnity.so unity-package/Assets/Plugins/FusionUnity/Android/libs/armeabi-v7a/
        
        # å¤åˆ¶Androidåº“ - 64ä½ARMv8a
        cp artifacts/android-arm64/libFusionUnity.so unity-package/Assets/Plugins/FusionUnity/Android/libs/arm64-v8a/
        
        # å¤åˆ¶Unityè„šæœ¬
        if [ -d "unity/Scripts" ]; then
          cp unity/Scripts/*.cs unity-package/Assets/Scripts/FusionUnity/
        fi
        
        # åˆ›å»ºREADME
        cat > unity-package/README.md << 'EOF'
        # Fusion Unity Package for Headset Tracking
        
        ä¸“ä¸ºå¤´æ˜¾IMUä¼ æ„Ÿå™¨èžåˆè®¾è®¡çš„Unityåº“ï¼Œæ”¯æŒWindowså¼€å‘å’ŒAndroidéƒ¨ç½²ã€‚
        
        ## å¹³å°æ”¯æŒ
        - âœ… Windows x64 (Unityç¼–è¾‘å™¨)
        - âœ… Android ARMv7a 32ä½ (armv8A 32ä½å…¼å®¹)
        - âœ… Android ARMv8a 64ä½ (arm64-v8a)
        
        ## æ ¸å¿ƒåŠŸèƒ½
        **åŽ»é™¤é‡åŠ›çš„åŠ é€Ÿåº¦æ•°æ®** - è¿™æ˜¯æ‚¨å¤´æ˜¾ä½ç½®ä¼°è®¡çš„å…³é”®ï¼
        
        ```csharp
        public class HeadsetController : MonoBehaviour {
            public FusionIMU fusionIMU;

            void Update() {
                Vector3 gyro = GetIMUGyroscope();    // rad/s
                Vector3 accel = GetIMUAccelerometer(); // m/sÂ²
                fusionIMU.UpdateIMU(gyro, accel, Time.deltaTime);

                // èŽ·å–åŽ»é™¤é‡åŠ›çš„åŠ é€Ÿåº¦ - ç”¨äºŽä½ç½®ä¼°è®¡
                Vector3 linearAccel = fusionIMU.linearAcceleration;  // ä¼ æ„Ÿå™¨åæ ‡ç³»
                Vector3 earthAccel = fusionIMU.earthAcceleration;    // ä¸–ç•Œåæ ‡ç³» (æŽ¨è)
                
                // ç»“åˆCameraçš„ä½ç½®æ•°æ®è¿›è¡Œèžåˆ
                UpdateHeadsetPosition(earthAccel);
            }
        }
        ```
        
        ## å®‰è£…æ–¹æ³•
        1. å°†æ•´ä¸ªAssetsæ–‡ä»¶å¤¹å¤åˆ¶åˆ°æ‚¨çš„Unityé¡¹ç›®
        2. ä¸ºGameObjectæ·»åŠ FusionIMUç»„ä»¶
        3. è¿žæŽ¥æ‚¨çš„IMUæ•°æ®æº
        4. éƒ¨ç½²åˆ°Androidå¤´æ˜¾è®¾å¤‡
        
        ## é‡è¦è¯´æ˜Ž
        - `linearAcceleration`: ä¼ æ„Ÿå™¨åæ ‡ç³»ä¸‹åŽ»é™¤é‡åŠ›çš„åŠ é€Ÿåº¦
        - `earthAcceleration`: ä¸–ç•Œåæ ‡ç³»ä¸‹åŽ»é™¤é‡åŠ›çš„åŠ é€Ÿåº¦ â­ **æŽ¨èç”¨äºŽä½ç½®ä¼°è®¡**
        - é…åˆæ‚¨çš„Camera solvePNPæ•°æ®ä½¿ç”¨ï¼Œå®žçŽ°å®Œæ•´çš„6DOFå¤´æ˜¾è¿½è¸ª
        EOF

    - name: Package for Unity
      run: |
        cd unity-package
        zip -r ../FusionUnity-Headset-Package.zip .

    - name: Upload Unity package
      uses: actions/upload-artifact@v4
      with:
        name: FusionUnity-Headset-Package
        path: FusionUnity-Headset-Package.zip
        retention-days: 90

    - name: Create release summary
      run: |
        echo "## ðŸŽ¯ å¤´æ˜¾è¿½è¸ªä¸“ç”¨Fusionåº“ç¼–è¯‘å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ åŒ…å«å†…å®¹:" >> $GITHUB_STEP_SUMMARY
        echo "- Windows x64 DLL (Unityç¼–è¾‘å™¨)" >> $GITHUB_STEP_SUMMARY
        echo "- Android ARMv7a 32ä½åº“ (armv8A 32ä½å…¼å®¹)" >> $GITHUB_STEP_SUMMARY
        echo "- Android ARMv8a 64ä½åº“ (arm64-v8a)" >> $GITHUB_STEP_SUMMARY
        echo "- Unity C# è„šæœ¬å’Œç¤ºä¾‹" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ æ ¸å¿ƒåŠŸèƒ½:" >> $GITHUB_STEP_SUMMARY
        echo "- **è‡ªåŠ¨é‡åŠ›è¡¥å¿** - è¾“å‡ºåŽ»é™¤é‡åŠ›çš„çº¿æ€§åŠ é€Ÿåº¦" >> $GITHUB_STEP_SUMMARY
        echo "- **é«˜ç²¾åº¦å§¿æ€ä¼°è®¡** - åŸºäºŽMadgwickç®—æ³•çš„ä¼ æ„Ÿå™¨èžåˆ" >> $GITHUB_STEP_SUMMARY
        echo "- **å¤´æ˜¾ä¼˜åŒ–** - ä¸“ä¸ºå¤´æ˜¾IMUç‰¹æ€§è°ƒä¼˜" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½:" >> $GITHUB_STEP_SUMMARY
        echo "åœ¨Artifactsä¸­ä¸‹è½½ \`FusionUnity-Headset-Package.zip\`" >> $GITHUB_STEP_SUMMARY 